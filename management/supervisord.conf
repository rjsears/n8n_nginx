[supervisord]
nodaemon=true
user=root
logfile=/app/logs/supervisord.log
logfile_maxbytes=10MB
logfile_backups=3
pidfile=/var/run/supervisord.pid
childlogdir=/app/logs

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# FastAPI/Uvicorn backend
[program:uvicorn]
command=uvicorn api.main:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info
directory=/app
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=30
stopasgroup=true
killasgroup=true
stdout_logfile=/app/logs/uvicorn.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/app/logs/uvicorn_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
environment=PYTHONUNBUFFERED="1",PYTHONPATH="/app"

# Nginx for static files and reverse proxy
[program:nginx]
command=nginx -g "daemon off;"
autostart=true
autorestart=true
startsecs=5
startretries=3
stopwaitsecs=10
stdout_logfile=/app/logs/nginx_access.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=/app/logs/nginx_error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3

# NFS health monitor (checks connection every 60 seconds)
[program:nfs_monitor]
command=/bin/bash -c "while true; do /app/scripts/nfs_health.sh >> /app/logs/nfs_monitor.log 2>&1; sleep 60; done"
autostart=true
autorestart=true
startsecs=5
stdout_logfile=/dev/null
stderr_logfile=/dev/null

# Group for easy management
[group:n8n_mgmt]
programs=uvicorn,nginx,nfs_monitor
priority=999
